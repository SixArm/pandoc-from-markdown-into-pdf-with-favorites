#!/bin/sh

# pandoc-from-markdown-into-pdf-with-favorites
#
# Convert from a markdown file into a PDF file.
#
# Thanks to https://learnbyexample.github.io/customizing-pandoc/
#
#
# ## Prerequisites
#
# This script requires pandoc and xelatex to be installed.
#
#
# ### macOS install
#
# Example using brew:
#
# ```sh
# brew install pandoc
# brew install mactex
# ```
#
# Verify the programs are runnable:
#
# ```sh
# $ which pandoc
# /usr/local/bin/pandoc
#
# $ pandoc --version
# pandoc 2.17.1.1
#
# $ which xelatex
# /Library/TeX/texbin/xelatex
#
# $ xelatex --version
# XeTeX 3.141592653-2.6-0.999993 (TeX Live 2021)
# ```
#
#
# ## Fonts
#
# This script prefers Bitstream Vera fonts because they
# are widely available with a good license for this work.
#
#   * main font: Bitstream Vera Sans
#
#   * code font: Bitstream Vera Sans Mono
#
# We have tried various ways to install fonts.
#
#   * Run `brew install --cask font-*`` (works for general use but pandoc can't find these fonts)
#
#   * download a font file to directory `~/.fonts` (works for `fc-list` but pandoc can't find these fonts)
#
#   * download a font file and install it via macOS "Font Book" app.
#
#
# ### Install a font via macOS + download + Font Book
#
#   1. Download a font file
#
#   2. Launch the macOS app "Font Book"
#
#   3. Use the app to add the font.
#
#
# ### Install a font via macOS + brew
#
# ```sh
# brew install --cask font-bitstream-vera
# ```
#
#
# ### Install a font via download and directory
#
#   1. Download a font file `.ttf`.
#
#   2. Put the file into an expected directory such as `~/.fonts`.
#
#   3. Refresh the font cache by running `sudo fc-cache -fv`.
#
#   4. Confirm the font has been loaded by running `fc-list | grep ExampleFontName`
#
#   5. Add the mainfont variable to the Pandoc command: `-V mainfont="ExampleFontName"`.
#
# 
# ### List fonts
#
# To list the xelatex fonts that are usable:
#
# ```sh
# $ fc-list
# ````

# sixarm-unix-shell-functions
# https://github.com/SixArm/sixarm-unix-shell-functions

EX_UNAVAILABLE=69

die() {
        n="$1" ; shift ; >&2 printf %s\\n "$*" ; exit "$n"
}

cmd() {
        command -v "$1" >/dev/null 2>&1
}

cmd_or_die() {
        cmd "$1" || die "$EX_UNAVAILABLE" "Command needed: $1"
}

font_exists() {
        fc-list | grep -q ": $1:"
}

font_exists_or_die() {
        font_exists "$1" || die "$EX_UNAVAILABLE" "Font needed: $1"
}

# Preflight

cmd_or_die "pandoc"
cmd_or_die "xelatex"

font_exists_or_die "Bitstream Vera Serif"
font_exists_or_die "Bitstream Vera Sans"
font_exists_or_die "Bitstream Vera Sans Mono"

# Main

DIR0=$(dirname $0)

pandoc \
    -f gfm \
    -V linkcolor:blue \
    -V geometry:a4paper \
    -V geometry:margin=2.5cm \
    -V mainfont="Bitstream Vera Serif" \
    -V sansfont="Bitstream Vera Sans" \
    -V monofont="Bitstream Vera Sans Mono" \
    -V fontsize=12pt \
    --highlight-style="$DIR0/pygments.theme" \
    --pdf-engine=xelatex \
    --include-in-header="$DIR0/chapter.tex" \
    --include-in-header="$DIR0/blockquote.tex" \
    --include-in-header="$DIR0/bullet.tex" \
    --include-in-header="$DIR0/inline_code.tex" \
    --toc \
    --toc-depth=2 \
   "$@" 

# Unused:
#    --listings -H "$DIR0/listings-setup.tex" \
